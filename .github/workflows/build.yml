cmake_minimum_required(VERSION 3.15)

project(Emulator
    VERSION 1.0.0
    LANGUAGES CXX
)

# --------------------------------------------------
# C++ Standard
# --------------------------------------------------
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# --------------------------------------------------
# Default build type
# --------------------------------------------------
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

# --------------------------------------------------
# Output directories
# --------------------------------------------------
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# --------------------------------------------------
# Compiler flags
# --------------------------------------------------
if(MSVC)
    add_compile_options(/W4 /permissive-)
    if(CMAKE_BUILD_TYPE STREQUAL "Release")
        add_compile_options(/O2 /DNDEBUG)
    endif()
else()
    add_compile_options(-Wall -Wextra -pedantic)
    if(CMAKE_BUILD_TYPE STREQUAL "Release")
        add_compile_options(-O3 -DNDEBUG)
    else()
        add_compile_options(-g)
    endif()
endif()

# --------------------------------------------------
# SDL2 (from MSYS2 / system)
# --------------------------------------------------
find_package(SDL2 REQUIRED)

# --------------------------------------------------
# nlohmann/json (SYSTEM VERSION – NO FetchContent ❌)
# --------------------------------------------------
find_package(nlohmann_json CONFIG REQUIRED)

# --------------------------------------------------
# Source files
# --------------------------------------------------
file(GLOB SRC_FILES
    src/*.cpp
)

file(GLOB HEADER_FILES
    include/*.h
)

# --------------------------------------------------
# Executable
# --------------------------------------------------
add_executable(Emulator
    ${SRC_FILES}
    ${HEADER_FILES}
)

# --------------------------------------------------
# Include directories
# --------------------------------------------------
target_include_directories(Emulator PRIVATE
    ${CMAKE_SOURCE_DIR}/include
)

# --------------------------------------------------
# Link libraries
# --------------------------------------------------
if(TARGET SDL2::SDL2)
    target_link_libraries(Emulator PRIVATE
        SDL2::SDL2
        SDL2::SDL2main
        nlohmann_json::nlohmann_json
    )
else()
    target_include_directories(Emulator PRIVATE ${SDL2_INCLUDE_DIRS})
    target_link_libraries(Emulator PRIVATE
        ${SDL2_LIBRARIES}
        nlohmann_json::nlohmann_json
    )
endif()

# --------------------------------------------------
# Assets (empty folder safe ✅)
# --------------------------------------------------
if(EXISTS "${CMAKE_SOURCE_DIR}/assets")
    file(COPY "${CMAKE_SOURCE_DIR}/assets"
         DESTINATION "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
endif()

# --------------------------------------------------
# Copy SDL2.dll on Windows
# --------------------------------------------------
if(WIN32)
    find_file(SDL2_DLL
        NAMES SDL2.dll
        PATHS
            ENV PATH
            C:/msys64/mingw64/bin
        NO_DEFAULT_PATH
    )

    if(SDL2_DLL)
        add_custom_command(TARGET Emulator POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
            ${SDL2_DLL}
            $<TARGET_FILE_DIR:Emulator>
            COMMENT "Copying SDL2.dll"
        )
    endif()
endif()

# --------------------------------------------------
# Install (optional)
# --------------------------------------------------
install(TARGETS Emulator DESTINATION bin)

if(EXISTS "${CMAKE_SOURCE_DIR}/assets")
    install(DIRECTORY assets DESTINATION .)
endif()




